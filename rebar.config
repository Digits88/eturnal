{minimum_otp_vsn, "21.0"}.

{deps,
 [{stun, {git, "https://github.com/processone/stun.git", {tag, "1.0.36"}}},
  {conf, {git, "https://github.com/processone/conf.git", {tag, "0.1.0"}}},
  {recon, {git, "https://github.com/ferd/recon.git", {tag, "2.5.1"}}}]}.

{relx,
 [{release, {eturnal, {cmd, "scripts/get-version"}},
   [eturnal,
    sasl,
    runtime_tools,
    recon]},
  {sys_config, "./config/sys.config"},
  {vm_args, "./config/vm.args"},
  {dev_mode, true},
  {system_libs, false},
  {include_erts, false},
  {extended_start_script, true},
  {extended_start_script_hooks,
   [{pre_start,
     [{custom, "hooks/pre_start"}]},
    {post_start,
     [{wait_for_process, eturnal}]}]},
  {extended_start_script_extensions,
   [{reload, "extensions/reload"},
    {sessions, "extensions/sessions"},
    {loglevel, "extensions/loglevel"},
    {version, "extensions/version"}]},
  {overlay_vars, "build.config"},
  {overlay,
   [{copy, "LICENSE", "doc/LICENSE.txt"},
    {copy, "CHANGELOG.md", "doc/CHANGELOG.md"},
    {copy, "README.md", "doc/README.md"},
    {copy, "scripts/extensions/reload", "bin/extensions/reload"},
    {copy, "scripts/extensions/sessions", "bin/extensions/sessions"},
    {copy, "scripts/extensions/loglevel", "bin/extensions/loglevel"},
    {copy, "scripts/extensions/version", "bin/extensions/version"},
    {copy, "scripts/hooks/pre_start", "bin/hooks/pre_start"},
    {copy, "config/eturnal.yml", "etc/eturnal.yml"},
    {template, "config/eturnal.service", "etc/systemd/system/eturnal.service"},
    {template, "scripts/eturnal.init", "etc/init.d/eturnal"},
    {template, "scripts/eturnalctl", "bin/eturnalctl"}]}]}.

{erl_opts,
 [{platform_define, "^21\.[0-2]\.", old_logger},
  {platform_define, "^2[12]\.", old_crypto},
  debug_info]}.

{dialyzer,
 [{warnings,
   [unknown,
    no_return,
    no_unused,
    no_improper_lists,
    no_fun_app,
    no_match,
    no_opaque,
    no_fail_call,
    no_contracts,
    no_behaviours,
    no_undefined_callbacks,
    unmatched_returns,
    error_handling,
    race_conditions]},
  {plt_extra_apps, % Nested dependencies which we call directly.
   [fast_tls,
    yval]}]}.

{xref_checks,
 [undefined_function_calls,
  undefined_functions,
  deprecated_function_calls,
  deprecated_functions,
  locals_not_used]}.

{profiles,
 [{prod,
   [{relx,
     [{dev_mode, false},
      {system_libs, true},
      {include_erts, true},
      {include_src, false}]},
    {erl_opts,
     [warnings_as_errors]}]},
  % Stripped-down binary release:
  {stripped,
   [{relx,
     [{dev_mode, false},
      {system_libs, true},
      {include_erts, true},
      {include_src, false},
      {exclude_apps,
       [sasl,
        runtime_tools,
        recon]}]},
    {erl_opts,
     [no_debug_info,
      deterministic,
      warnings_as_errors]},
    {post_hooks,
     [{release, "erl -noinput -eval \\
       \"{ok, _} = beam_lib:strip_release('$REBAR_BUILD_DIR/rel/eturnal'),
         halt()\""}]}]},
  % Distribution packaging:
  {distro,
   [{relx,
     [{dev_mode, false},
      {system_libs, false},
      {include_erts, false},
      {include_src, false},
      {exclude_apps,
       [sasl,
        runtime_tools,
        recon]}]},
    {erl_opts,
     [no_debug_info,
      deterministic]},
    {post_hooks,
     [{release, "erl -noinput -eval \\
       \"{ok, _} = beam_lib:strip_release('$REBAR_BUILD_DIR/rel/eturnal'),
         halt()\""}]}]},
  {test,
   [{erl_opts,
     [warnings_as_errors,
      nowarn_export_all]}]}]}.

{overrides,
 [{del, stun,
   [{erl_opts, % Let 'stun' use the new logging API on Erlang/OTP 21 as well.
     [{platform_define, "^(R|1|20|21)", 'USE_OLD_LOGGER'}]}]}]}.

{alias,
 [{check,
   [xref,
    dialyzer,
    ct]},
  {bump,
   [{clean, "-a"},
    update,
    upgrade]}]}.
